{% extends "learnlogs/base.html" %}

{% block content %}
<div class="container">
    <div class="row clearfix">
        <div class="col-md-8 col-md-offset-2" >
            <form class="form-signin" action="{% url 'users:forgetpw' %}" method="post">
                <h1 class="form-signin-heading text-muted">重置密码</h1>
                {% if form.non_field_errors %}
                    <ul class='form-errors'>
                        {% for error in form.non_field_errors %}
                            <li style="list-style-type:none;">{{ error }}</li>
                        {% endfor %}
                    </ul>
                {% endif %}
                {% csrf_token %}
                <input name="email" id="email" type="email" class="form-control" placeholder="Email地址（找回账户）" autofocus="">
                <input name="auth" type="text" class="form-control" placeholder="验证码" required="">
                <input name="password1" type="password" class="form-control" placeholder="新密码" required="">
                <input name="password2" type="password" class="form-control" placeholder="新密码，再输入一次" required="">

                <div class="text-right form_btn">
                    <a class="btn btn-primary" id="btn_code" style="display:inline;margin: 10px;padding: 11px">获取验证码</a>
                    <input class="btn btn-primary" id="btn_submit" type="submit" value="确定" style="width:60px;display:inline;"/>
                </div>
            </form>
</div></div></div> 

<script type="text/javascript">
        function time_run(time_check){
            time_check -= 1;
            $("#btn_code").text("("+time_check+")重新获取");
            if(time_check>0){
                //setTimeout('time_run('+time_check+')', 1000);
                setTimeout(function(){time_run(time_check)}, 1000);
            }else{
                $("#btn_code").text("获取验证码");
                $("#btn_code").removeClass("disabled");
            }
        }
 
        $(document).ready(function() {
            $("#btn_code").click(function(){
                //获取填写的邮箱，并检查
                var email_tip = $(".text-danger")[0];
                var email = document.getElementById("email").value;
                email_tip.innerText = '';
 
                var myreg = /^([a-zA-Z0-9]+[_|\_|\.]?)*[a-zA-Z0-9]+@([a-zA-Z0-9]+[_|\_|\.]?)*[a-zA-Z0-9]+\.[a-zA-Z]{2,3}$/;
                if(!myreg.test(email)){
                    email_tip.innerText = '* 请正确地填写邮箱'
                    return false;
                }
 
                //发送验证码
                $.ajax({
                    type:"GET",
                    url:"{% url 'users:get_email_code' %}?email=" + email,
                    cache:false,
                    dataType:'json',
                    success:function(result){
                        if(result['success']){
                            //提示
                            var code_tip = $(".text-danger")[3];
                            code_tip.innerText = '已经发送验证码到您填写的邮箱中'
 
                            //禁用按钮
                            $("#btn_code").addClass("disabled");
                            //倒计时
                            time_run(60);
                        }else{
                            alert(result['message']);
                        }                        
                    },
                    error:function(XMLHttpRequest, textStatus, errorThrown){
                        alert("获取出错，稍后再试一下吧。")
                    }
                });
            });
        });
</script>
{% endblock %}